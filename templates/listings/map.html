{% extends 'base.html' %}
{% load static %}

{% block content %}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
>

<style>
  /* Map and layout */
  #map {
    width: 100%;
    height: 70vh;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  }
  .leaflet-container a { text-decoration: none; }
  .map-toolbar { margin: 15px 0; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .map-wrapper { margin: 20px 0; }
  .legend { font-size: 12px; color: #555; margin-top: 8px; }
  .legend code { background: #f3f3f3; padding: 2px 4px; border-radius: 3px; }

  /* Popup container subtle animation */
  .leaflet-popup-content-wrapper {
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    animation: pop-fade 280ms ease-out;
  }
  @keyframes pop-fade { from { transform: translateY(4px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  /* Tooltip preview on marker hover */
  .coral-tooltip {
    background: #0b1120; /* deep navy */
    color: #fff;
    border-radius: 8px;
    border: none;
    box-shadow: 0 10px 24px rgba(0,0,0,0.2);
    padding: 0;
  }
  .coral-tooltip .tooltip-inner { padding: 0; }
  .coral-tip-content { display: flex; align-items: center; gap: 10px; padding: 8px 10px; }
  .coral-tip-thumb { width: 56px; height: 42px; border-radius: 6px; object-fit: cover; flex: 0 0 auto; }
  .coral-tip-title { font-weight: 600; line-height: 1.2; font-size: 13px; }
  .coral-tip-price { opacity: 0.9; font-size: 12px; }

  /* Carousel inside popup */
  .popup-card { width: 300px; max-width: 78vw; }
  .popup-carousel { position: relative; width: 100%; overflow: hidden; border-radius: 8px; background: #111827; }
  .carousel-track { display: flex; width: 100%; transition: transform 350ms ease; }
  .carousel-slide { min-width: 100%; height: 180px; position: relative; }
  .carousel-slide img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
  .carousel-nav { position: absolute; inset: 0; display: flex; align-items: center; justify-content: space-between; pointer-events: none; padding: 0 6px; }
  .carousel-btn { pointer-events: all; width: 32px; height: 32px; border-radius: 50%; display: grid; place-items: center; border: 0; background: rgba(255,255,255,0.85); color: #111; box-shadow: 0 2px 10px rgba(0,0,0,0.15); transition: background 160ms ease, transform 160ms ease; }
  .carousel-btn:hover { background: #fff; transform: translateY(-1px); }
  .carousel-dots { position: absolute; bottom: 8px; left: 0; right:0; display: flex; justify-content: center; gap: 6px; }
  .carousel-dot { width: 7px; height: 7px; border-radius: 50%; background: rgba(255,255,255,0.6); transition: transform 160ms ease, background 160ms ease; }
  .carousel-dot.active { transform: scale(1.15); background: #fff; }

  .popup-meta { padding: 8px 4px 0; line-height: 1.25; }
  .popup-title { font-weight: 700; font-size: 15px; margin-bottom: 2px; }
  .popup-price { color: #0f766e; font-weight: 700; }
  .popup-addr, .popup-specs { color: #475569; font-size: 12px; }

  @media (max-width: 576px) {
    #map { height: 65vh; }
    .carousel-slide { height: 170px; }
  }
  @media (min-width: 1200px) { #map { height: 75vh; } }
</style>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <h2>Map of Listings</h2>
      <p class="text-muted">Interactive map with clustered listings. Click a marker to see details.</p>

      <div class="map-toolbar">
        <button id="fit-btn" class="btn btn-primary btn-sm">Fit to Results</button>
        <a href="{% url 'listings:listings' %}" class="btn btn-secondary btn-sm">Back to Listings</a>
        <div class="legend">Data endpoint: <code>/listings/map-data/</code>. Update filters server-side as needed.</div>
      </div>

      <div class="map-wrapper">
        <div id="map"></div>
      </div>
    </div>
  </div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
  (function () {
    var map = L.map('map');

    // OSM tiles (you may swap to another provider)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    var markers = L.markerClusterGroup();
    var bounds = L.latLngBounds();

    function fmtCurrency(n) {
      try {
        return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n);
      } catch (e) {
        return n;
      }
    }

    function featureToMarker(f) {
      var coords = f.geometry.coordinates; // [lng, lat]
      var latlng = L.latLng(coords[1], coords[0]);
      bounds.extend(latlng);

      var p = f.properties || {};
      var html = buildPopupHTML(p);

      var marker = L.marker(latlng).bindPopup(html);

      // Hover preview via tooltip
      var tipImg = (p.photos && p.photos.length ? p.photos[0] : (p.photo_url || ''));
      var tip = '<div class="coral-tip-content">' +
        (tipImg ? ('<img class="coral-tip-thumb" src="' + tipImg + '" alt="preview">') : '') +
        '<div>' +
          '<div class="coral-tip-title">' + (p.title || 'Listing') + '</div>' +
          (p.price ? ('<div class="coral-tip-price">' + fmtCurrency(p.price) + '</div>') : '') +
        '</div>' +
      '</div>';
      marker.bindTooltip(tip, { direction: 'top', sticky: true, offset: [0, -10], opacity: 0.96, className: 'coral-tooltip' });

      return marker;
    }

    fetch('{% url 'listings:map_data' %}')
      .then(function (r) { return r.json(); })
      .then(function (geojson) {
        console.log('Received map data:', geojson);
        if (!geojson || !geojson.features) {
          console.warn('No features found in map data');
          return;
        }
        console.log('Number of features:', geojson.features.length);
        geojson.features.forEach(function (f) {
          console.log('Processing feature:', f);
          markers.addLayer(featureToMarker(f));
        });
        map.addLayer(markers);
        if (bounds.isValid()) {
          map.fitBounds(bounds.pad(0.1));
        } else {
          console.warn('No valid bounds - defaulting to world view');
          map.setView([0, 0], 2);
        }
      })
      .catch(function (e) {
        console.error('Failed to load map data', e);
        map.setView([0, 0], 2);
      });

    document.getElementById('fit-btn').addEventListener('click', function () {
      if (bounds.isValid()) {
        map.fitBounds(bounds.pad(0.1));
      }
    });

    // Build popup HTML with carousel and meta
    function buildPopupHTML(p) {
      var photos = Array.isArray(p.photos) && p.photos.length ? p.photos : (p.photo_url ? [p.photo_url] : []);
      var id = p.id || Math.random().toString(36).slice(2);
      var slides = photos.map(function(src){ return '<div class="carousel-slide"><img src="' + src + '" alt="photo"></div>'; }).join('');
      var dots = photos.map(function(_,i){ return '<div class="carousel-dot' + (i===0?' active':'') + '"></div>'; }).join('');
      var addrLine = [p.address, p.city, p.state].filter(Boolean).join(', ');
      var html = ''+
        '<div class="popup-card" data-listing-id="' + id + '">' +
          '<div class="popup-carousel js-carousel">' +
            '<div class="carousel-track">' + slides + '</div>' +
            (photos.length>1 ? (
              '<div class="carousel-nav">' +
                '<button class="carousel-btn js-prev" aria-label="Previous">&#10094;</button>' +
                '<button class="carousel-btn js-next" aria-label="Next">&#10095;</button>' +
              '</div>' +
              '<div class="carousel-dots">' + dots + '</div>'
            ) : '') +
          '</div>' +
          '<div class="popup-meta">' +
            '<div class="popup-title">' + (p.title || 'Listing') + '</div>' +
            (p.price ? '<div class="popup-price">' + fmtCurrency(p.price) + '</div>' : '') +
            (addrLine ? '<div class="popup-addr">' + addrLine + '</div>' : '') +
            ((p.bedrooms||p.bathrooms) ? '<div class="popup-specs">' + (p.bedrooms||'-') + ' bd Â· ' + (p.bathrooms||'-') + ' ba</div>' : '') +
            (p.url ? '<div style="margin-top:6px"><a class="btn btn-primary btn-sm" href="' + p.url + '">View details</a></div>' : '') +
          '</div>' +
        '</div>';
      return html;
    }

    // Initialize carousel when popup opens
    map.on('popupopen', function(e){
      var root = e && e.popup && e.popup._contentNode ? e.popup._contentNode : null;
      if (!root) return;
      var car = root.querySelector('.js-carousel');
      if (!car) return;
      setupCarousel(car);
    });

    function setupCarousel(container){
      var track = container.querySelector('.carousel-track');
      if (!track) return;
      var slides = Array.from(track.children);
      var prevBtn = container.querySelector('.js-prev');
      var nextBtn = container.querySelector('.js-next');
      var dotsWrap = container.querySelector('.carousel-dots');
      var dots = dotsWrap ? Array.from(dotsWrap.children) : [];
      var index = 0;

      function update(){
        track.style.transform = 'translateX(' + (-index * 100) + '%)';
        dots.forEach(function(d,i){ d.classList.toggle('active', i===index); });
      }
      function go(delta){ index = (index + delta + slides.length) % slides.length; update(); }

      if (prevBtn) prevBtn.addEventListener('click', function(){ go(-1); });
      if (nextBtn) nextBtn.addEventListener('click', function(){ go(1); });
      if (dotsWrap) dots.forEach(function(d,i){ d.addEventListener('click', function(){ index=i; update(); }); });

      // Touch swipe
      var startX = 0; var dx = 0; var touching = false;
      container.addEventListener('touchstart', function(ev){
        touching = true; startX = (ev.touches && ev.touches[0] ? ev.touches[0].clientX : 0); dx = 0;
      }, {passive: true});
      container.addEventListener('touchmove', function(ev){
        if (!touching) return; var x = ev.touches && ev.touches[0] ? ev.touches[0].clientX : 0; dx = x - startX;
      }, {passive: true});
      container.addEventListener('touchend', function(){
        if (!touching) return; touching = false; if (Math.abs(dx) > 30) { go(dx > 0 ? -1 : 1); }
      });

      // Keyboard accessibility
      container.setAttribute('tabindex', '0');
      container.addEventListener('keydown', function(ev){
        if (ev.key === 'ArrowLeft') { go(-1); }
        else if (ev.key === 'ArrowRight') { go(1); }
      });

      update();
    }
  })();
</script>
{% endblock %}
